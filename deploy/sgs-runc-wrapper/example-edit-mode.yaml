# SGS Stateful Container - Edit Mode (OCI Runtime Wrapper Version)
#
# This version uses the sgs-runc-wrapper for TRUE rootfs replacement.
# The container's Root.Path is changed to the PVC - no overlayfs shadowing.
#
# Prerequisites:
# 1. sgs-runc-wrapper installed on nodes (/usr/local/bin/sgs-runc-wrapper)
# 2. containerd configured with "sgs" runtime
# 3. RuntimeClass "sgs" created
# 4. PVC populated with base OS
---
apiVersion: v1
kind: Pod
metadata:
  name: node-volume-edit
  annotations:
    # Triggers the sgs-runc-wrapper to modify Root.Path
    sgs.snucse.org/os-volume: "node-volume"
spec:
  # Use SGS RuntimeClass
  runtimeClassName: sgs
  
  containers:
    - name: main
      image: busybox:latest
      command: ["/bin/bash"]
      stdin: true
      tty: true
      volumeMounts:
        # Beacon mount - Kubelet attaches PVC here,
        # sgs-runc-wrapper uses its source as Root.Path,
        # any mountPath is fine but you need to mention it,
        # otherwise, the shim cannot find the PVC mount.
        - name: boot-volume
          mountPath: /var/lib/sgs/boot
      resources:
        requests:
          cpu: 0
          memory: 0
        limits:
          cpu: "4"
          memory: "16Gi"
          nvidia.com/gpu: 1
          nvidia.com/gpu-mem: "0" # HAMi: GPU present but 0MB memory (Edit Mode)
  
  volumes:
    - name: boot-volume
      persistentVolumeClaim:
        claimName: node-volume
